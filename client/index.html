<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/babel" >
        "use strict";

        let canvas;
        let ctx;

        let myUser = undefined;
        let users = {};

        let nodes = [];
        let links = [];

        let selectedNode;

        const connectSocket = () => {
            let sock = io.connect();

            sock.on('connect', () => {
                console.log('connecting');

                // Get your user's info
                sock.on('userInfo', function(data){
                    myUser = data;
                    console.log(data);
                });

                // Update current game state
                sock.on('currentGameState', function(data){
                    users = data.users;
                    nodes = data.nodes;
                    links = data.links;
                });

                // Handle user join
                sock.on('userJoined', function(data){
                    users[data.id] = data;
                    console.log(data.id + ' joined.')
                });

                // Handle user disconnect
                sock.on('userLeft', function(data){
                    delete users[data.id];
                    console.log(data.id+ ' left.');
                });
            });
        };



        const init = () => {
            canvas = document.querySelector('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx = canvas.getContext('2d');

            window.onmousedown = function(e){
                // If the mouse is inside a node
                let mX = e.clientX;
                let mY = e.clientY;
                for(var i=0; i<nodes.length; i++){
                    let n = nodes[i];
                    let dist = Math.sqrt(Math.pow(mX-n.x,2) + Math.pow(mY-n.y,2));
                    if(dist < n.power){
                        selectedNode = n;
                        break;
                    }
                }
            };

            window.onmouseup = function(e){
                let targetNode;
                for(var i=0; i<nodes.length; i++){
                    let n = nodes[i];
                    let dist = Math.sqrt(Math.pow(mX-n.x,2) + Math.pow(mY-n.y,2));
                    if(dist < n.power){
                        targetNode = n;
                        break;
                    }
                }
                if(selectedNode && targetNode){
                    makeLink(selectedNode, targetNode);
                }
            }

            connectSocket();

            start();
        };

        const start = () => {
            tick();
        };

        const tick = () => {
            draw(ctx);

            window.requestAnimationFrame(tick);
        };

        const draw = (ctx) => {
            drawBackground(ctx);
            drawLinks(ctx);
            drawNodes(ctx);
        };

        const drawBackground = (ctx) => {
            ctx.save();

            ctx.fillStyle = 'darkblue';
            ctx.fillRect(0,0,canvas.width,canvas.height);

            ctx.restore();
        };

        const drawLinks = (ctx) => {

        };

        const drawNodes = (ctx) => {
            for(var i=0; i<nodes.length; i++){
                let n = nodes[i];
                ctx.save();
                ctx.fillStyle = (n.owner) ? users[n.owner].color : 'gray';
                ctx.beginPath();
                ctx.arc(n.x, n.y, n.power, 0, Math.PI*2);
                ctx.fill();
                ctx.restore();
            }

            if(selectedNode){
                ctx.save();
                ctx.strokeStyle = 'white';
                ctx.beginPath();
                ctx.arc(selectedNode.x, selectedNode.y, selectedNode.power, 0, Math.PI*2);
                ctx.stroke();
                ctx.restore();
            }
        };

        window.onload = init;
    
    </script>
    <style>
        *{margin:0;padding:0;}
    </style>   
</head>
<body>
    <canvas></canvas>
</body>
</html>